name: Test and Deploy
run-name: ${{ github.actor }} has triggered Test and Deploy ðŸš€
on:
  push:
    branches:
      - main
  #     - develop
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-24.04
    outputs:
      coverage: ${{ steps.phpunit.outputs.coverage }}
      new_version: ${{ steps.phpunit.outputs.new_version }}
      old_version: ${{ steps.phpunit.outputs.old_version }}
    steps:
      - name: Checkout files in the runner
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Setup php 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          coverage: apcu, pcov

      - name: Validate composer.json and composer.lock
        run: composer validate --strict

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: php-${{ hashFiles('composer.lock') }}

      - name: Install prod and dev dependencies
        run: composer install --prefer-dist --no-progress --no-suggest --no-interaction
       
      - name: Generate .env file from .env-example
        run: |
          cp .env-example .env
      
      - name: Run all test suites
        id: phpunit
        run: |
          PHP_INI_DIR=$(php -r "echo PHP_CONFIG_FILE_SCAN_DIR;")
          echo "apc.enable_cli=1" | sudo tee "$PHP_INI_DIR/99-apcu-cli.ini"
          composer server & sleep 2 && composer tests-all
          php vendor/bin/coverage-check .test-results/coverage/clover.xml ${{ vars.MIN_COVERAGE }}
          coverage=$(php vendor/bin/coverage-check .test-results/coverage/clover.xml 1 --only-percentage | grep -Eo '[0-9.]+%' | sed 's/%//')
          old_version=$(git tag -l --sort=-v:refname | head -2 | tail -1)
          new_version=$(git tag -l --sort=-v:refname | head -1)
          echo "coverage=$coverage" >> $GITHUB_OUTPUT
          echo "old_version=$old_version" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

  deploy:
    needs: test
    runs-on: ubuntu-24.04

    steps:
      - name: Setup WARP to enable IPv6
        uses: fscarmen/warp-on-actions@v1.2
        with:
          stack: dual

      - name: Checkout files in the runner
        uses: actions/checkout@v4

      - name: Setup php 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Install only prod dependencies
        run: composer install --no-dev --prefer-dist --no-progress --no-suggest --no-interaction

      - name: Prepare shipping dir
        run: ./.github/prepare-dist.sh ${{ needs.test.outputs.new_version }}

      - name: Deploy on server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SERV_KEYS }}
          ARGS: "--recursive --links --owner --group --perms --compress --checksum --verbose"
          SOURCE: "dist/"
          REMOTE_HOST: ${{ vars.SERV_ADDR }}
          REMOTE_USER: ${{ secrets.SERV_USER }}
          REMOTE_PORT: ${{ secrets.SERV_PORT }}
          TARGET: ${{ vars.SERV_PATH }}/${{ needs.test.outputs.new_version }}
          SCRIPT_BEFORE: |
            mkdir -p  ${{ vars.SERV_PATH }}
          SCRIPT_AFTER: |
            cp -p ${{ vars.SERV_PATH }}/${{ needs.test.outputs.old_version }}/var/database/main.db ${{ vars.SERV_PATH }}/${{ needs.test.outputs.new_version }}/var/database
            ln -snfr ${{ vars.SERV_PATH }}/${{ needs.test.outputs.new_version }} ${{ vars.SERV_PATH }}/current

      - name: Update coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_KEY }}
          gistID: 07bb4b086f8e7dea73754e73bc5c1bb2
          filename: azertype-coverage.json
          label: coverage
          message: ${{ needs.test.outputs.coverage }}%
          valColorRange: ${{ needs.test.outputs.coverage }}
          minColorRange: ${{ vars.MIN_COVERAGE }}
          maxColorRange: 100

      - name: Update version badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_KEY }}
          gistID: 07bb4b086f8e7dea73754e73bc5c1bb2
          filename: azertype-version.json
          label: version
          message: ${{ needs.test.outputs.new_version }}
          color: blue